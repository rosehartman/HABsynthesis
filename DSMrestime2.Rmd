---
title: "More DSM residence time analyss"
author: "Rosie"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(sf)
library(ordinal)
library(broom)
library(vegan)
library(lme4)
library(lmerTest)
library(effects)
library(MuMIn)
library(vegan)
library(ggeffects)
library(visreg)
library(wql)
```


My models were all a bit of a mess. It's not really working very well with the residence time values. The salinity relationship makes no sense. I'm going to limit the datast to just the past five years. I may want to limit it to just the delta and kick out SUisun


```{r}
load("data/HABrestime.RData")

HABres2 = HABrestime %>%
  st_drop_geometry() %>%
  filter(Year>2014, !is.na(Temperature), !is.na(ResTime), !is.na(Region),
                 !is.na(Station), !is.na(Microcystis), Month %in% c(6:10)) %>%
  mutate(MicF = case_when(Microcystis ==1 ~ "Absent",
                                                 Microcystis %in% c(2, 2.5, 3, 3.5)~ "Mid",
                                                 Microcystis %in% c(4, 4.5,5) ~ "High"),
                    MicF = factor(MicF, levels = c("Absent", "Mid", "High"), ordered = T))
  


#boxplot of residence time by microcystis scores
ggplot(HABres2, aes(x =Mic, y = ResTime, color = Yr_type)) + 
  geom_boxplot()+
  facet_wrap(~Region)

#scatterplot of microcystis scores by residence time
ggplot(HABres2, aes(x =ResTime, y = Microcystis, color = Yr_type)) + 
  geom_point(position = "jitter")+
  facet_wrap(~Region, scales = "free_x")


```

Now an ordered regression

```{r}

m1 = clmm(MicF ~ ResTime+ Temperature+ Month + (1|Station)+ (1|Year), data = HABres2)


summary(m1)

#not as exciting as I'd think
#Also, i need to work on how to plot this.

HABres2$fits = fitted(m1)

ggplot(HABres2, aes( ResTime, fits, color = MicF))+ geom_point()+ geom_smooth(method = "lm")+
  ylab("Probability")+ xlab("Residence TIme")


ggplot(HABres2, aes(Temperature, fits, color = MicF))+ geom_point()+ geom_smooth(method = "lm")+
  ylab("Probability")+ xlab("Temperature")

ggplot(HABres2, aes(as.factor(Month), fits, fill = MicF))+ geom_boxplot()+
  ylab("Probability")+ xlab("Month")

ggplot(HABres2, aes(x = Temperature, y = Microcystis))+ geom_point()+ 
  facet_wrap(~Region)

ggplot(HABres2, aes(x = MicF, y = Temperature))+ geom_boxplot()+ 
  facet_wrap(~Region)+ geom_hline(yintercept = 25)


```

UGH. Still not great

Binomial presence absence by region

```{r}



micbin = group_by(HABres2, Region, Year, Month) %>%
  summarize(Present = length(Microcystis[which(Microcystis>1)]), Absent = length(Microcystis[which(Microcystis==1)]),
            ResTime = mean(ResTime), Temperature = mean(Temperature, na.rm =T), Salinity = mean(Salinity, na.rm = T)) %>%
  ungroup() %>%
            mutate(Year2 = Year-2000, Temp = scale(Temperature), Res = scale(ResTime), Sal = scale(Salinity))


```


```{r}
library(MuMIn)

micbin2017 = filter(micbin, !is.na(Sal), Year > 2016) %>%
  mutate(logres = log(Res+1))
global17 = glmer(cbind(Present, Absent)~ Temp + logres + Month+ Sal+(1|Year2)+ (1|Region), data = micbin2017, family = "binomial", na.action = "na.fail")
mods2017 = dredge(global17)
write.csv(as.data.frame(mods2017), "MicrocystisModels.csv")

#Month, salinity, and temperature are the best predictors, residence time close behind

best17.2 =  glmer(cbind(Present, Absent)~ Temp + Month+ logres+Sal+ (1|Year2)+ (1|Region), data = micbin2017, family = "binomial", na.action = "na.fail")
summary(best17.2)

plot(allEffects(best17.2, residuals = TRUE))
```

Let's be sure our diagnostic plots look good before anything else

```{r}
plot(best17.2)

library(DHARMa)
simres = simulateResiduals(best17.2)
plot(simres)
#not too bad, though some deviation

```




```{r}
effs = allEffects(best17.2, partial.residuals = TRUE)
test = ggeffect(best17.2, terms = "Temp")
test2 = ggpredict(best17.2, terms = "Temp [all]")
#OK, need to find a pretty way to plot this
library(visreg)

visreg(best17.2, scale = "response")
foo = visreg(best17.2, scale = "response")

Backscale = function(X, dfvar){
  y = X* sd((dfvar-mean(dfvar, narm =t)), na.rm =T) + mean(dfvar, na.rm =T)
  return(y)
}

saltest = lm(Sal ~ Salinity, data = micbin2017)
summary(saltest)
#OK, now all the partial residual plots!!
#first temperature
ggplot() + geom_point(data =foo[[1]]$res, aes(x = Backscale(Temp, micbin2017$Temperature), y = visregRes))+
  geom_line(data = foo[[1]]$fit, aes(x = Backscale(Temp, micbin2017$Temperature), y = visregFit))+
  geom_ribbon(data = test2, aes(x = Backscale(x, micbin2017$Temperature), ymin = conf.low, ymax = conf.high),
              alpha = 0.2, fill = "blue")+
  theme_bw()+
  ylab("Proportion of monthly observations \nwith Microcystis present")+
  xlab("Water Temperature (C)")
ggsave("plots/Tempplot.tiff", device = "tiff", width = 5, height =5)


#Now month
montheff = ggpredict(best17.2, terms = "Month [all]")
ggplot() + geom_point(data =foo[[2]]$res, aes(x = Month, y = visregRes))+
  geom_line(data = foo[[2]]$fit, aes(x = Month, y = visregFit))+
    geom_ribbon(data = montheff, aes(x = x, ymin = conf.low, ymax = conf.high),
              alpha = 0.2, fill = "blue")+
  theme_bw()+
  ylab("Proportion of monthly observations \nwith Microcystis present")+
  xlab("Month of year")


#residnece time
reseff = ggpredict(best17.2, terms = "logres [all]")
ggplot() + geom_point(data =foo[[3]]$res, aes(x = Backscale(exp(logres)-1,micbin2017$ResTime), y = visregRes))+
  geom_line(data = foo[[3]]$fit, aes(x = Backscale(exp(logres)-1,micbin2017$ResTime), y = visregFit))+
  geom_ribbon(data = reseff, aes(x = Backscale(exp(x)-1, micbin2017$ResTime), ymin = conf.low, ymax = conf.high),
              alpha = 0.2, fill = "blue")+
  theme_bw()+
  ylab("Proportion of monthly observations \nwith Microcystis present")+
  xlab("Water Residence time (hours)")

ggsave("plots/Resplot.tiff", device = "tiff", width = 5, height =5)

#Salinity
saleff = ggpredict(best17.2, terms = "Sal [all]")
ggplot() + geom_point(data =foo[[4]]$res, aes(x = Backscale(Sal,micbin2017$Salinity), y = visregRes))+
  geom_line(data = foo[[4]]$fit, aes(x = Backscale(Sal,micbin2017$Salinity), y = visregFit))+
  geom_ribbon(data = saleff, aes(x = Backscale(x, micbin2017$Salinity), ymin = conf.low, ymax = conf.high),
              alpha = 0.2, fill = "blue")+
  theme_bw()+
  ylab("Proportion of monthly observations \nwith Microcystis present")+
  xlab("Salinity (PSU)")

ggsave("plots/Salplot.tiff", device = "tiff", width = 5, height =5)



```

```{r}
#Pretty version of model results
library(broom.mixed)
summod = tidy(best17.2)

write.csv(summod, "Micmod.csv")

```

Mine wants a more balanced design

```{r}



micbin2 = filter(HABres2, Year > 2016, Source != "Prop1", Source != "StocktonWF") %>%
  group_by(Region, Year, Month) %>%
  summarize(Present = length(Microcystis[which(Microcystis>1)]), Absent = length(Microcystis[which(Microcystis==1)]),
            ResTime = mean(ResTime), Temperature = mean(Temperature, na.rm =T), Salinity = mean(Salinity, na.rm = T)) %>%
  ungroup() %>%
            mutate(Year2 = Year-2000, Temp = scale(Temperature), Res = scale(ResTime), Sal = scale(Salinity),
                   logres = log(Res +1))

global2 = glmer(cbind(Present, Absent)~ Temp + logres + Month+ Sal+(1|Year2)+ (1|Region), data = micbin2, family = "binomial", na.action = "na.fail")
mods2 = dredge(global2)
write.csv(as.data.frame(mods2), "MicrocystisModels2.csv")



#Month, salinity, and temperature are the best predictors, residence time close behind

best2 =  glmer(cbind(Present, Absent)~ Temp + Month+ logres+Sal+ (1|Year2)+ (1|Region), data = micbin2, family = "binomial", na.action = "na.fail")
summary(best2)

plot(allEffects(best2, residuals = TRUE))

#pretty much the same result
```



Look at data by region, compare physical variables.

```{r}



physreg = group_by(HABres2, Region, Year) %>%
  summarize(Present = length(Microcystis[which(Microcystis>1)]), Absent = length(Microcystis[which(Microcystis==1)]), Percent = Present/(Present+Absent),
            ResTime = mean(ResTime), Temperature = mean(Temperature, na.rm =T), Salinity = mean(Salinity, na.rm = T),
            Secchi = mean(Secchi, na.rm =T), Depth = mean(Depth, na.rm =T)) %>%
  group_by(Region) %>%
  summarise(Present = mean(Present), Absent = mean(Absent), Percent =Present/(Present+Absent), ResTime = mean(ResTime), Temperature = mean(Temperature, na.rm =T), Salinity = mean(Salinity, na.rm = T), Secchi = mean(Secchi, na.rm =T), Depth = mean(Depth, na.rm =T))

ggplot(physreg, aes(x = Region, y = Salinity))+ geom_col()

ggplot(physreg, aes(x = Region, y = ResTime))+ geom_col()
ggplot(physreg, aes(x = Region, y = Temperature))+ geom_col()
ggplot(physreg, aes(x = Percent, y = Salinity))+ geom_point()+ geom_smooth()
ggplot(physreg, aes(x = Percent, y = Temperature))+ geom_point()+ geom_smooth()
ggplot(physreg, aes(x = Percent, y = ResTime))+ geom_point()+ geom_smooth()

```
Let's try an NMDS plot

```{r}

physreg = mutate(physreg, Depth = case_when(is.nan(Depth) ~ 8,
                                            TRUE ~ Depth))
regmat = as.matrix(select(physreg, Temperature, Salinity, ResTime, Depth, Secchi)) 

mds1 = metaMDS(regmat, autotransform =T)

plot(mds1, type = "t")

data.scores <- as.data.frame(scores(mds1)$sites)  #Using the scores function from vegan to extract the site scores and convert to a 
data.scores$Region = physreg$Region
data.scores$Percent = physreg$Percent
vars = as.data.frame(scores(mds1)$species)
vars$Label = row.names(vars)
  
ggplot(data.scores, aes(x = NMDS1, y = NMDS2))+ geom_point(aes(size = Percent), alpha = 0.5, color = "lightskyblue")+
  geom_text(aes(label = Region))+ 
  geom_text(data = vars, aes(label = Label), color = "red")+
  geom_segment(data = vars, aes(x = 0, y =0, xend = NMDS1, yend = NMDS2), 
               arrow = arrow(length = unit(0.1,"cm")), inherit.aes = FALSE, 
               color = "red")+
  scale_size_continuous(range = c(1,10), name = "Percent\nof samples \nwith Microcysits\nPresent")+
  theme_bw()
  
ggplot(physreg, aes(x = Region, y = Depth)) + geom_col()

```

